---

- name: get etcd version from kubernetes github 
  shell: wget -q -O- https://api.github.com/repos/coreos/etcd/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/'
  register: etcd_version 
  
# TODO: change for other architectures 
- name: download etcd
  get_url: 
    url: "https://github.com/coreos/etcd/releases/download/{{ etcd_version.stdout }}/etcd-{{ etcd_version.stdout }}-linux-amd64.tar.gz"
    dest: "{{ ansible_env.GOPATH }}/src/k8s.io/kubernetes/third_party"

- name: prevent downloading in the etcd script
  ansible.builtin.replace:
    path: "{{ ansible_env.GOPATH }}/src/k8s.io/kubernetes/hack/lib/etcd.sh" 
    regexp: ".*https://github.com.*|kube::util::download_file.*"
    replace: "#removed by ansible in build/etcd.yml"

